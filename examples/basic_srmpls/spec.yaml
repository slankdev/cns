# http://www.asciiflow.com

preinit:
  - cmds:
    - cmd: modprobe mpls_router
    - cmd: modprobe mpls_gso
    - cmd: modprobe mpls_iptunnel

nodes:
  - name: R1
    image: cnsnode
    interfaces:
    - { name: net0, type: direct, opts: R1#net0 }
    - { name: net1, type: direct, opts: R4#net0 }
  - name: R2
    image: cnsnode
    interfaces:
    - { name: net0, type: direct, opts: R1#net0 }
    - { name: net1, type: direct, opts: R3#net0 }
    - { name: net2, type: direct, opts: R4#net2 }
  - name: R3
    image: cnsnode
    interfaces:
    - { name: net0, type: direct, opts: R2#net1 }
    - { name: net1, type: direct, opts: R4#net1 }
  - name: R4
    image: cnsnode
    interfaces:
    - { name: net0, type: direct, opts: R1#net1 }
    - { name: net1, type: direct, opts: R3#net1 }
    - { name: net2, type: direct, opts: R2#net2 }

node_configs:
  - name: R1
    cmds:
      - cmd: sysctl -w net.ipv4.ip_forward=1
      - cmd: sysctl -w net.mpls.conf.lo.input=1
      - cmd: sysctl -w net.mpls.conf.net0.input=1
      - cmd: sysctl -w net.mpls.conf.net1.input=1
      - cmd: sysctl -w net.mpls.platform_labels=1048575
      - cmd: >-
          vtysh -c 'conf t'
          -c 'interface lo'
          -c ' ip address 10.255.0.1/32'
          -c ' ip ospf area 0.0.0.0'
          -c 'exit'
          -c 'interface net0'
          -c ' ip address 10.0.0.1/30'
          -c ' ip ospf area 0.0.0.0'
          -c 'exit'
          -c 'interface net1'
          -c ' ip address 10.0.0.9/30'
          -c ' ip ospf area 0.0.0.0'
          -c 'exit'

  - name: R2
    cmds:
      - cmd: sysctl -w net.ipv4.ip_forward=1
      - cmd: sysctl -w net.mpls.conf.lo.input=1
      - cmd: sysctl -w net.mpls.conf.net0.input=1
      - cmd: sysctl -w net.mpls.conf.net1.input=1
      - cmd: sysctl -w net.mpls.conf.net2.input=1
      - cmd: sysctl -w net.mpls.platform_labels=1048575
      - cmd: >-
          vtysh -c 'conf t'
          -c 'interface lo'
          -c ' ip address 10.255.0.2/32'
          -c ' ip ospf area 0.0.0.0'
          -c 'exit'
          -c 'interface net0'
          -c ' ip address 10.0.0.2/30'
          -c ' ip ospf area 0.0.0.0'
          -c 'exit'
          -c 'interface net1'
          -c ' ip address 10.0.0.5/30'
          -c ' ip ospf area 0.0.0.0'
          -c 'exit'
          -c 'interface net2'
          -c ' ip address 10.0.0.13/30'
          -c ' ip ospf area 0.0.0.0'
          -c 'exit'

  - name: R3
    cmds:
      - cmd: sysctl -w net.ipv4.ip_forward=1
      - cmd: sysctl -w net.mpls.conf.lo.input=1
      - cmd: sysctl -w net.mpls.conf.net0.input=1
      - cmd: sysctl -w net.mpls.conf.net1.input=1
      - cmd: sysctl -w net.mpls.platform_labels=1048575
      - cmd: >-
          vtysh -c 'conf t'
          -c 'interface lo'
          -c ' ip address 10.255.0.3/32'
          -c ' ip ospf area 0.0.0.0'
          -c 'exit'
          -c 'interface net0'
          -c ' ip address 10.0.0.6/30'
          -c ' ip ospf area 0.0.0.0'
          -c 'exit'
          -c 'interface net1'
          -c ' ip address 10.0.0.17/30'
          -c ' ip ospf area 0.0.0.0'
          -c 'exit'

  - name: R4
    cmds:
      - cmd: sysctl -w net.ipv4.ip_forward=1
      - cmd: sysctl -w net.mpls.conf.lo.input=1
      - cmd: sysctl -w net.mpls.conf.net0.input=1
      - cmd: sysctl -w net.mpls.conf.net1.input=1
      - cmd: sysctl -w net.mpls.conf.net2.input=1
      - cmd: sysctl -w net.mpls.platform_labels=1048575
      - cmd: >-
          vtysh -c 'conf t' -c
          'interface lo' -c
          ' ip address 10.255.0.2/32' -c
          ' ip ospf area 0.0.0.0' -c
          'exit' -c
          'interface net0' -c
          ' ip address 10.0.0.10/30' -c
          ' ip ospf area 0.0.0.0' -c
          'exit' -c
          'interface net1' -c
          ' ip address 10.0.0.18/30' -c
          ' ip ospf area 0.0.0.0' -c
          'exit' -c
          'interface net2' -c
          ' ip address 10.0.0.14/30' -c
          ' ip ospf area 0.0.0.0' -c
          'exit'

test:
  - cmds:
    ## Basic P2P-Link's Test
    - cmd: docker exec R1 ping -c2 10.0.0.2
    - cmd: docker exec R1 ping -c2 10.0.0.10
    - cmd: docker exec R2 ping -c2 10.0.0.1
    - cmd: docker exec R2 ping -c2 10.0.0.6
    - cmd: docker exec R2 ping -c2 10.0.0.14
    - cmd: docker exec R3 ping -c2 10.0.0.5
    - cmd: docker exec R3 ping -c2 10.0.0.18
    - cmd: docker exec R4 ping -c2 10.0.0.9
    - cmd: docker exec R4 ping -c2 10.0.0.17
    - cmd: docker exec R4 ping -c2 10.0.0.13
    ## Basic Routing Test
    # - cmd: docker exec S0 ping6 -c2 fc00:c::2
    # - cmd: docker exec S0 ping6 -c2 fc00:b::10
    # - cmd: docker exec S0 ping6 -c2 fc00:b::20
    # - cmd: docker exec S1 ping6 -c2 fc00:a::2
    # - cmd: docker exec S1 ping6 -c2 fc00:b::10
    # - cmd: docker exec S1 ping6 -c2 fc00:b::20


